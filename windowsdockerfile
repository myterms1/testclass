FROM mcr.microsoft.com/windows/servercore:ltsc2022

# Make RUN use PowerShell
SHELL ["powershell","-NoProfile","-NonInteractive","-ExecutionPolicy","Bypass","-Command"]

# Copy PEM (avoid trailing single backslash)
COPY zscaler.pem C:\\

# Import Zscaler certs into LocalMachine\Root and \CA
RUN $ErrorActionPreference='Stop'; Set-Location $env:TEMP; `
    $certBundleFile='C:\zscaler.pem'; `
    $certStores=@('Root','CA'); `
    $certBundle=Get-Content $certBundleFile -Raw; `
    $parts=$certBundle -split '-----END CERTIFICATE-----\r?\n'; `
    $i=1; `
    foreach($p in $parts){ `
      if($p -match 'BEGIN CERTIFICATE'){ `
        $out=('zscaler_ca-{0}.pem' -f $i); $i++; `
        Set-Content -Path $out -Value ($p + '-----END CERTIFICATE-----') -NoNewline; `
        foreach($store in $certStores){ certutil -addstore $store $out | Out-Null } `
      } `
    }

# Dynatrace args/env
ARG DT_API_URL
ARG DT_ONEAGENT_OPTIONS
ARG DT_PAAS_TOKEN
ENV DT_API_URL=${DT_API_URL}
ENV DT_ONEAGENT_OPTIONS=${DT_ONEAGENT_OPTIONS}
ENV DT_PAAS_TOKEN=${DT_PAAS_TOKEN}

WORKDIR C:/OneAgentInstall
COPY .\setup-oneagent.ps1 .\
RUN .\setup-oneagent.ps1

USER ContainerUser
