FROM mcr.microsoft.com/windows/servercore:ltsc2022

# Make RUN use PowerShell (WS2022 defaults to cmd.exe)
SHELL ["powershell","-NoProfile","-NonInteractive","-ExecutionPolicy","Bypass","-Command"]

# Copy PEM
COPY zscaler.pem C:\

# <<< make sure there is a newline above this line ^ >>>

# Your original logic, but executed directly (no Invoke-Expression)
RUN Set-Location $env:TEMP; `
    $certBundleFile = 'C:\zscaler.pem'; `
    $certStores = @('Root','CA'); `
    $certBundle = Get-Content $certBundleFile | Out-String; `
    $certs = $certBundle -Split "(?<=-----END CERTIFICATE-----)" + [System.Environment]::NewLine; `
    $i = 1; `
    foreach ($cert in $certs) { `
        $certFile = "zscaler_ca-$i.pem"; $i++; `
        if ($cert) { `
            $cert | Out-File -FilePath $certFile; `
            foreach ($certStore in $certStores) { certutil -addstore $certStore $certFile } `
        } `
    }

# Dynatrace args/env (one per line; no backticks)
ARG DT_API_URL
ARG DT_ONEAGENT_OPTIONS
ARG DT_PAAS_TOKEN
ENV DT_API_URL=${DT_API_URL}
ENV DT_ONEAGENT_OPTIONS=${DT_ONEAGENT_OPTIONS}
ENV DT_PAAS_TOKEN=${DT_PAAS_TOKEN}

WORKDIR C:/OneAgentInstall
COPY .\setup-oneagent.ps1 .\
RUN .\setup-oneagent.ps1

USER ContainerUser
