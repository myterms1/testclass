version: 0.2
phases:
  install:
    on-failure: ABORT
    runtime-versions:
      java: corretto17
    commands:
      - echo "üöÄ Debugging Variables in buildspec.yml üöÄ"
      - echo "AWS_ACCOUNT_ID: '$AWS_ACCOUNT_ID'"
      - echo "ENV: '$ENV'"

      - |
        # Normalize environment variable cases (convert to uppercase for safety)
        ENV_UPPER=$(echo "$ENV" | tr '[:lower:]' '[:upper:]')
        ACCOUNT_ID=$(echo "$AWS_ACCOUNT_ID" | sed 's/^0*//') # Remove leading zeros

        echo "Normalized ENV: '$ENV_UPPER'"
        echo "Normalized AWS_ACCOUNT_ID: '$ACCOUNT_ID'"

        # Determine the correct S3 bucket name dynamically
        if [[ "$ACCOUNT_ID" == "84828583690" && ( "$ENV_UPPER" == "INT" || "$ENV_UPPER" == "PVS" ) ]]; then
          BUCKET_NAME="usmg-${ENV}-ipm-artifacts-bucket-${ACCOUNT_ID}"
        elif [[ "$ACCOUNT_ID" == "7777777777" && "$ENV_UPPER" == "PROD" ]]; then
          BUCKET_NAME="usmg-${ENV}-ipm-artifacts-bucket-${ACCOUNT_ID}"
        elif [[ "$ACCOUNT_ID" == "851725216779" && "$ENV_UPPER" == "DEV" ]]; then
          BUCKET_NAME="usmg-${ENV}-ipm-artifacts-bucket-${ACCOUNT_ID}"
        else
          echo "‚ùå ERROR: Environment ($ENV) and Account ID ($AWS_ACCOUNT_ID) not recognized!"
          exit 1
        fi

        echo "‚úÖ Using S3 bucket: $BUCKET_NAME"

      - aws s3 cp s3://$BUCKET_NAME/liquibase_foundation/combined.pem /etc/pki/ca-trust/source/anchors/combined.pem
      - update-ca-trust
      - dnf install postgresql15 tar gzip findutils -y
      - mkdir -p /opt/liquibase
      - curl -sLo /opt/liquibase/liquibase.tar.gz https://github.com/liquibase/liquibase/releases/download/v4.25.0/liquibase-4.25.0.tar.gz
      - tar -xf /opt/liquibase/liquibase.tar.gz -C /opt/liquibase && rm /opt/liquibase/liquibase.tar.gz
  build:
    on-failure: ABORT
    commands:
      - export PATH=$PATH:/opt/liquibase
      - export PGUSER=$(echo $DB_CREDS | jq -r '.username')
      - export PGPASSWORD=$(echo $DB_CREDS | jq -r '.password')
      - psql --version
      - liquibase --version
      - ./scripts/run.sh $RUN_ARGS







# Pass AWS_ACCOUNT_ID and ENV explicitly
build=$(aws codebuild start-build \
    --project-name "$project" \
    --source-location-override "${bucket}/liquibase/${BUILD_NUMBER}.zip" \
    --logs-config-override "cloudWatchLogs={status=ENABLED,groupName=${logs},streamName=${BUILD_NUMBER}}" \
    --environment-variables-override \
        "name=AWS_ACCOUNT_ID,value=$account,type=PLAINTEXT" \
        "name=ENV,value=${ENV},type=PLAINTEXT" \
        "name=RUN_ARGS,value=${COMMAND} ${CHANGESET},type=PLAINTEXT")

